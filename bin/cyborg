#! /usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path("../lib", File.dirname(__FILE__)))

require 'optparse'
require 'cyborg'

options = {assets: []}

def next_arg
  if ARGV.first && !ARGV.first.match(/^-/)
    ARGV.shift
  end
end

OptionParser.new do |opts|

  options[:help] = ARGV.shift if %w(help h).include?(ARGV.first)

  if ARGV.empty?
    options[:help] = true
  else
    options[:command] = next_arg
  end

  opts.banner = Cyborg::Help.banner(options[:command])

  if %w(n new).include? options[:command]
    options[:name] = next_arg

    opts.on("-e", "--engine ENGINE_NAME", String, "Name the engine (defaults to gem name)") do |engine|
      options[:engine] = engine
    end

    opts.on("-f", "--force", "overwrite existing files") do |val|
      options[:force] = true
    end
  end

  if %w(s server).include? options[:command]
    opts.on("-w", "--watch", "Watch assets") do |val|
      options[:watch] = true
    end
  end

  if %w(b w s build watch server).include? options[:command]
    opts.on("-j", "--js", "Build javascripts.") do |val|
      options[:select_assets] = true
      options[:js] = true
    end
    opts.on("-c", "--css", "Build css.") do |val|
      options[:select_assets] = true
      options[:css] = true
    end
    opts.on("-s", "--svg", "Build svgs.") do |val|
      options[:select_assets] = true
      options[:svg] = true
    end
    opts.on("-P", "--production", "Build assets as with production mode.") do |val|
      options[:production] = true
    end
    opts.on("-C", "--clean", "Remove cache files before build.") do |val|
      options[:clean] = true
    end
  end

  if %w(s server).include? options[:command]
    opts.on("-p", "--port PORT", String, "serve site at port") do |val|
      options[:port] = val
    end
  end

  opts.on("-v", "--version", "Print version") do |version|
    options[:command] = 'version'
  end

  opts.on("-h", "--help", "Print this message") do |version|
    options[:help] = opts
  end

  if options[:help]
    options[:help] = opts
  end
end.parse!

Cyborg::Command.run(options)
